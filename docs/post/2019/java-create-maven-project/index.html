<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>mavenプロジェクト作成からCIOps構築まで | A4 tech note</title>
<meta name=keywords content>
<meta name=description content="git branchに変更が加わった際、
 JUnit test (with MySQL) docker build Kubernetes環境にデプロイ (CIOps)  が行われるJavaプロジェクトを構築します。
 本番運用ではArgoCDなどgitOps構築をお勧めします
 登場するもの OSS  Maven MySQL Docker  サービス  GitHub CircleCI AWS (ECR, EKS) ⇦ 微修正でその他マネージドk8sにも応用可能かと思います。  サンプルプロジェクトの実装 最終的にディレクトリ構成はこんな感じになります。順を追って作っていきます。 GitHubからcloneして頂いても結構です。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  testproject/ ├ src/ │ ├ main/ │ │ └ java/ │ │ └testpackage/ │ │ └Main.java │ └ test/ │ └ java/ │ └testpackage/ │ └MainTest.">
<meta name=author content>
<link rel=canonical href=https://aaaanwz.github.io/post/2019/java-create-maven-project/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://aaaanwz.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://aaaanwz.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://aaaanwz.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://aaaanwz.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://aaaanwz.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CWBPGKYRHB"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-CWBPGKYRHB',{anonymize_ip:!1})}</script>
<meta property="og:title" content="mavenプロジェクト作成からCIOps構築まで">
<meta property="og:description" content="git branchに変更が加わった際、
 JUnit test (with MySQL) docker build Kubernetes環境にデプロイ (CIOps)  が行われるJavaプロジェクトを構築します。
 本番運用ではArgoCDなどgitOps構築をお勧めします
 登場するもの OSS  Maven MySQL Docker  サービス  GitHub CircleCI AWS (ECR, EKS) ⇦ 微修正でその他マネージドk8sにも応用可能かと思います。  サンプルプロジェクトの実装 最終的にディレクトリ構成はこんな感じになります。順を追って作っていきます。 GitHubからcloneして頂いても結構です。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  testproject/ ├ src/ │ ├ main/ │ │ └ java/ │ │ └testpackage/ │ │ └Main.java │ └ test/ │ └ java/ │ └testpackage/ │ └MainTest.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://aaaanwz.github.io/post/2019/java-create-maven-project/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2019-07-24T00:00:00+00:00">
<meta property="article:modified_time" content="2019-07-24T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="mavenプロジェクト作成からCIOps構築まで">
<meta name=twitter:description content="git branchに変更が加わった際、
 JUnit test (with MySQL) docker build Kubernetes環境にデプロイ (CIOps)  が行われるJavaプロジェクトを構築します。
 本番運用ではArgoCDなどgitOps構築をお勧めします
 登場するもの OSS  Maven MySQL Docker  サービス  GitHub CircleCI AWS (ECR, EKS) ⇦ 微修正でその他マネージドk8sにも応用可能かと思います。  サンプルプロジェクトの実装 最終的にディレクトリ構成はこんな感じになります。順を追って作っていきます。 GitHubからcloneして頂いても結構です。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  testproject/ ├ src/ │ ├ main/ │ │ └ java/ │ │ └testpackage/ │ │ └Main.java │ └ test/ │ └ java/ │ └testpackage/ │ └MainTest.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://aaaanwz.github.io/post/"},{"@type":"ListItem","position":2,"name":"mavenプロジェクト作成からCIOps構築まで","item":"https://aaaanwz.github.io/post/2019/java-create-maven-project/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"mavenプロジェクト作成からCIOps構築まで","name":"mavenプロジェクト作成からCIOps構築まで","description":"git branchに変更が加わった際、\n JUnit test (with MySQL) docker build Kubernetes環境にデプロイ (CIOps)  が行われるJavaプロジェクトを構築します。\n 本番運用ではArgoCDなどgitOps構築をお勧めします\n 登場するもの OSS  Maven MySQL Docker  サービス  GitHub CircleCI AWS (ECR, EKS) ⇦ 微修正でその他マネージドk8sにも応用可能かと思います。  サンプルプロジェクトの実装 最終的にディレクトリ構成はこんな感じになります。順を追って作っていきます。 GitHubからcloneして頂いても結構です。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  testproject/ ├ src/ │ ├ main/ │ │ └ java/ │ │ └testpackage/ │ │ └Main.java │ └ test/ │ └ java/ │ └testpackage/ │ └MainTest.","keywords":[],"articleBody":"git branchに変更が加わった際、\n JUnit test (with MySQL) docker build Kubernetes環境にデプロイ (CIOps)  が行われるJavaプロジェクトを構築します。\n 本番運用ではArgoCDなどgitOps構築をお勧めします\n 登場するもの OSS  Maven MySQL Docker  サービス  GitHub CircleCI AWS (ECR, EKS) ⇦ 微修正でその他マネージドk8sにも応用可能かと思います。  サンプルプロジェクトの実装 最終的にディレクトリ構成はこんな感じになります。順を追って作っていきます。 GitHubからcloneして頂いても結構です。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  testproject/ ├ src/ │ ├ main/ │ │ └ java/ │ │ └testpackage/ │ │ └Main.java │ └ test/ │ └ java/ │ └testpackage/ │ └MainTest.java ├ .cifcleci/ │ └ config.yml ├ schema.sql ├ pom.xml ├ deploy.yaml └ Dockerfile   1. スキーマ定義 テーブルスキーマを記述します。resourceフォルダに置いても良いのですが、今回はトップディレクトリに配置することにします。\nデータベース名は指定しません。\n1  CREATE TABLE user (id int, name varchar(10));   2. mavenプロジェクト作成 先ほどのtableに適当なレコードを挿入する最小限のJavaプロジェクトを実装します。\nJDBC、JUnit、maven-assembly-pluginを使用します。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59   xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\" 4.0.0 aaaanwz test 0.0.1 testproject  11 11     mysql mysql-connector-java 8.0.17    org.junit.jupiter junit-jupiter-engine 5.3.1 test       maven-surefire-plugin 3.0.0-M3    maven-assembly-plugin   package  single       testpackage.Main    jar-with-dependencies         1レコード挿入するだけのMainクラスを実装します。\nデータベースへの接続情報は環境変数から取得します。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  package testpackage; import java.sql.Connection; import java.sql.DriverManager; import java.sql.PreparedStatement; import java.sql.SQLException; public class Main { public static void main(String[] args) throws ClassNotFoundException, SQLException { final String host = System.getenv(\"DB_HOST\"); final String dbname = System.getenv(\"DB_NAME\"); execute(host, dbname); } static void execute(String host, String dbname) throws ClassNotFoundException, SQLException { Class.forName(\"com.mysql.cj.jdbc.Driver\"); Connection conn = DriverManager.getConnection( \"jdbc:mySql://\" + host + \"/\" + dbname + \"?useSSL=false\", \"root\", \"\"); PreparedStatement stmt = conn.prepareStatement(\"INSERT INTO user(id,name) VALUES(?, ?)\"); stmt.setInt(1, 1); stmt.setString(2, \"Yamada\"); stmt.executeUpdate(); } }   レコードが挿入された事を確認するだけのテストを書きます。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  package testpackage; import static org.junit.jupiter.api.Assertions.assertEquals; import static org.junit.jupiter.api.Assertions.fail; import java.sql.Connection; import java.sql.DriverManager; import java.sql.ResultSet; import java.sql.SQLException; import java.sql.Statement; import org.junit.jupiter.api.AfterEach; import org.junit.jupiter.api.BeforeEach; import org.junit.jupiter.api.Test; import testpackage.Main; class MainTest { Statement stmt; @BeforeEach void before() throws ClassNotFoundException, SQLException { Class.forName(\"com.mysql.cj.jdbc.Driver\"); Connection conn = DriverManager.getConnection(\"jdbc:mySql://localhost/test?useSSL=false\", \"root\", \"\"); stmt = conn.createStatement(); } @AfterEach void after() throws SQLException { stmt.executeUpdate(\"TRUNCATE TABLE user\"); } @Test void test() throws Exception { Main.execute(\"localhost\", \"test\"); try (ResultSet rs = stmt.executeQuery(\"SELECT * FROM user WHERE id = 1;\")) { if (rs.next()) { assertEquals(\"Yamada\", rs.getString(\"name\")); } else { fail(); } } } }   3. Dockerfile作成 Dockerfileを書きます。テストは docker buildとは別のステップで行う予定のため、-DskipTestsを付与してビルド時のテストをスキップします。\nイメージサイズ削減のためmaven:3.6でビルド、openjdk11:apline-slimで実行するマルチステージビルドを行います。 maven:3.6では約800MB、openjdk11:alpine-slimでは約300MBとなります。現時点でECRの無料枠は500MBのため、個人開発では大きな差です。\n1 2 3 4 5 6 7 8 9 10  FROM maven:3.6 AS build ADD . /var/tmp/testproject/ WORKDIR /var/tmp/testproject/ RUN mvn -DskipTests package FROM adoptopenjdk/openjdk11:alpine-slim COPY --from=build /var/tmp/testproject/target/test-0.0.1-jar-with-dependencies.jar /usr/local/ CMD java -jar /usr/local/test-0.0.1-jar-with-dependencies.jar.jar   4. k8s yamlファイル作成 3.でビルドされたコンテナをk8sにデプロイするためのyamlを書きます。今回のプログラムは単発でSQLを実行して終了するため、kind: Jobにしてみます。Docker registryのurlは適宜置換してください。\nenvでDBへの接続情報を定義します。 DB_HOSTの値が mysqlとなっているのは、KubernetesのService経由で接続するためです。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  apiVersion: batch/v1 kind: Job metadata: name: test spec: template: spec: containers: - name: test image: your-docker-registry-url/testimage:latest imagePullPolicy: Always env: - name: DB_HOST value: \"mysql\" - name: DB_NAME value: \"ekstest\" restartPolicy: Never backoffLimit: 0   5. circleci configファイル作成 本稿のキモです。CircleCIで自動テスト/ビルドを行うための構成設定を書きます。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61  version: 2.1 orbs: aws-ecr: circleci/aws-ecr@6.1.0 aws-eks: circleci/aws-eks@0.2.1 kubernetes: circleci/kubernetes@0.3.0 jobs: test: # ①JUnit テストの実行 docker: - image: circleci/openjdk:11 - image: circleci/mysql:5.7 environment: MYSQL_ALLOW_EMPTY_PASSWORD: yes MYSQL_DATABASE: test command: [--character-set-server=utf8, --collation-server=utf8_general_ci, --default-storage-engine=innodb] steps: - checkout - run: name: Waiting for MySQL to be ready command: dockerize -wait tcp://localhost:3306 -timeout 1m - run: name: Install MySQL CLI; Create table; command: sudo apt-get install default-mysql-client \u0026\u0026 mysql -h 127.0.0.1 -uroot test - restore_cache: key: circleci-test-{{ checksum \"pom.xml\" }} - run: mvn dependency:go-offline - save_cache: paths: - ~/.m2 key: circleci-test-{{ checksum \"pom.xml\" }} - run: mvn test - store_test_results: path: target/surefire-reports deploy: # ③EKSへのkubectl apply executor: aws-eks/python3 steps: - checkout - kubernetes/install - aws-eks/update-kubeconfig-with-authenticator: cluster-name: test-cluster aws-region: \"${AWS_REGION}\" - run: command: | kubectl apply -f k8s-job.yaml name: apply workflows: test-and-deploy: jobs: - test: # ①JUnit テストの実行 filters: branches: only: develop - aws-ecr/build-and-push-image: # ②コンテナのビルドとECRへのpush filters: branches: only: master create-repo: true repo: \"testimage\" tag: \"latest\" - deploy: # ③EKSへのkubectl apply requires: - aws-ecr/build-and-push-image   ①JUnitテストの実行 filterによって、developブランチに変更が加わった際に mvn testが実行されるようにしてみました。この際テスト用MySQLインスタンスが立ち上がり、 testデータベースが準備されます。\n公式ドキュメントで詳しく解説されています。　 Language Guide: Java Database Configuration Examples  ②コンテナのビルドとECRへのpush masterブランチに変更が加わった際に、Dockerfileに従ってbuildし、ECRにpushします。\nOrbクイックスタートガイドで詳しく解説されています。\n③EKSへのkubectl apply ②が実施された後、4.で定義したJobを実行します。\ncircleci/aws-eksに解説がありますが、サンプルコードをよりシンプルに変更しました。\n@0.2.1のドキュメントによるとパラメータaws-regionはRequiredとなっていませんが、実際は必須のようです。ECRのpushで環境変数AWS_REGIONを要求されているので、これをそのまま使いました。\nインフラ設定 ほとんど公式ドキュメントへのリンク集です。\n1. ECR, EKS環境準備 1-1. 基本設定 test-clusterを立ち上げます。\n Getting Started with Amazon EKS Setting Up with Amazon ECR  1-2. EKS上にMySQLをデプロイ Kubernetes公式にDeploy MySQLというドキュメントが用意されています。\nkubectl exec -it mysql-0 mysqlコマンドからekstestデータベースとuserテーブルを用意します。\n2. CircleCI projectの設定 2-1. プロジェクトのセットアップ  quick-start  2-2. 環境変数の設定  circleci/aws-ecrでRequiredとなっている環境変数をCircleCI Projectに設定します。\nRoleに要求される権限の詳細は割愛します。  まとめ  develop branchにpush\nmvn testが実行され、テストレポートがCircleCIのTest summaryに表示されます。 master branchにpush\nECRにdocker imageがpushされ、EKSでJobが開始します。EKS上のMySQLに id:1 name:Yamadaレコードが挿入されます。  ","wordCount":"871","inLanguage":"en","datePublished":"2019-07-24T00:00:00Z","dateModified":"2019-07-24T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://aaaanwz.github.io/post/2019/java-create-maven-project/"},"publisher":{"@type":"Organization","name":"A4 tech note","logo":{"@type":"ImageObject","url":"https://aaaanwz.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://aaaanwz.github.io/ accesskey=h title="A4 tech note (Alt + H)">A4 tech note</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://aaaanwz.github.io/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://aaaanwz.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://aaaanwz.github.io/portfolio/ title=Portfolio>
<span>Portfolio</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
mavenプロジェクト作成からCIOps構築まで
</h1>
<div class=post-meta><span title="2019-07-24 00:00:00 +0000 UTC">July 24, 2019</span>
</div>
</header> <div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul><ul>
<li>
<a href=#%e7%99%bb%e5%a0%b4%e3%81%99%e3%82%8b%e3%82%82%e3%81%ae aria-label=登場するもの>登場するもの</a><ul>
<li>
<a href=#oss aria-label=OSS>OSS</a></li>
<li>
<a href=#%e3%82%b5%e3%83%bc%e3%83%93%e3%82%b9 aria-label=サービス>サービス</a></li></ul>
</li></ul>
<li>
<a href=#%e3%82%b5%e3%83%b3%e3%83%97%e3%83%ab%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e5%ae%9f%e8%a3%85 aria-label=サンプルプロジェクトの実装>サンプルプロジェクトの実装</a><ul>
<li>
<a href=#1-%e3%82%b9%e3%82%ad%e3%83%bc%e3%83%9e%e5%ae%9a%e7%be%a9 aria-label="1. スキーマ定義">1. スキーマ定義</a></li>
<li>
<a href=#2-maven%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e4%bd%9c%e6%88%90 aria-label="2. mavenプロジェクト作成">2. mavenプロジェクト作成</a></li>
<li>
<a href=#3-dockerfile%e4%bd%9c%e6%88%90 aria-label="3. Dockerfile作成">3. Dockerfile作成</a></li>
<li>
<a href=#4-k8s-yaml%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e4%bd%9c%e6%88%90 aria-label="4. k8s yamlファイル作成">4. k8s yamlファイル作成</a></li>
<li>
<a href=#5-circleci-config%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e4%bd%9c%e6%88%90 aria-label="5. circleci configファイル作成">5. circleci configファイル作成</a><ul>
<li>
<a href=#junit%e3%83%86%e3%82%b9%e3%83%88%e3%81%ae%e5%ae%9f%e8%a1%8c aria-label=①JUnitテストの実行>①JUnitテストの実行</a></li>
<li>
<a href=#%e3%82%b3%e3%83%b3%e3%83%86%e3%83%8a%e3%81%ae%e3%83%93%e3%83%ab%e3%83%89%e3%81%a8ecr%e3%81%b8%e3%81%aepush aria-label=②コンテナのビルドとECRへのpush>②コンテナのビルドとECRへのpush</a></li>
<li>
<a href=#eks%e3%81%b8%e3%81%aekubectl-apply aria-label="③EKSへのkubectl apply">③EKSへのkubectl apply</a></li></ul>
</li></ul>
</li>
<li>
<a href=#%e3%82%a4%e3%83%b3%e3%83%95%e3%83%a9%e8%a8%ad%e5%ae%9a aria-label=インフラ設定>インフラ設定</a><ul>
<li>
<a href=#1-ecr-eks%e7%92%b0%e5%a2%83%e6%ba%96%e5%82%99 aria-label="1. ECR, EKS環境準備">1. ECR, EKS環境準備</a><ul>
<li>
<a href=#1-1-%e5%9f%ba%e6%9c%ac%e8%a8%ad%e5%ae%9a aria-label="1-1. 基本設定">1-1. 基本設定</a></li>
<li>
<a href=#1-2-eks%e4%b8%8a%e3%81%abmysql%e3%82%92%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4 aria-label="1-2. EKS上にMySQLをデプロイ">1-2. EKS上にMySQLをデプロイ</a></li></ul>
</li>
<li>
<a href=#2-circleci-project%e3%81%ae%e8%a8%ad%e5%ae%9a aria-label="2. CircleCI projectの設定">2. CircleCI projectの設定</a><ul>
<li>
<a href=#2-1-%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e3%82%bb%e3%83%83%e3%83%88%e3%82%a2%e3%83%83%e3%83%97 aria-label="2-1. プロジェクトのセットアップ">2-1. プロジェクトのセットアップ</a></li>
<li>
<a href=#2-2-%e7%92%b0%e5%a2%83%e5%a4%89%e6%95%b0%e3%81%ae%e8%a8%ad%e5%ae%9a aria-label="2-2. 環境変数の設定">2-2. 環境変数の設定</a></li></ul>
</li></ul>
</li>
<li>
<a href=#%e3%81%be%e3%81%a8%e3%82%81 aria-label=まとめ>まとめ</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>git branchに変更が加わった際、</p>
<ul>
<li>JUnit test (with MySQL)</li>
<li>docker build</li>
<li>Kubernetes環境にデプロイ (CIOps)</li>
</ul>
<p>が行われるJavaプロジェクトを構築します。</p>
<blockquote>
<p>本番運用ではArgoCDなどgitOps構築をお勧めします</p>
</blockquote>
<h2 id=登場するもの>登場するもの<a hidden class=anchor aria-hidden=true href=#登場するもの>#</a></h2>
<h3 id=oss>OSS<a hidden class=anchor aria-hidden=true href=#oss>#</a></h3>
<ul>
<li>Maven</li>
<li>MySQL</li>
<li>Docker</li>
</ul>
<h3 id=サービス>サービス<a hidden class=anchor aria-hidden=true href=#サービス>#</a></h3>
<ul>
<li>GitHub</li>
<li>CircleCI</li>
<li>AWS (ECR, EKS) ⇦ 微修正でその他マネージドk8sにも応用可能かと思います。</li>
</ul>
<h1 id=サンプルプロジェクトの実装>サンプルプロジェクトの実装<a hidden class=anchor aria-hidden=true href=#サンプルプロジェクトの実装>#</a></h1>
<p>最終的にディレクトリ構成はこんな感じになります。順を追って作っていきます。
<a href=https://github.com/aaaanwz/java-autodeploy-example>GitHub</a>からcloneして頂いても結構です。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>testproject/
    ├ src/
    │   ├ main/
    │   │   └ java/
    │   │        └testpackage/
    │   │            └Main.java
    │   └ test/
    │       └ java/
    │           └testpackage/  
    │              └MainTest.java   
    ├ .cifcleci/
    │   └ config.yml
    ├ schema.sql
    ├ pom.xml
    ├ deploy.yaml
    └ Dockerfile

</code></pre></td></tr></table>
</div>
</div><h2 id=1-スキーマ定義>1. スキーマ定義<a hidden class=anchor aria-hidden=true href=#1-スキーマ定義>#</a></h2>
<p>テーブルスキーマを記述します。resourceフォルダに置いても良いのですが、今回はトップディレクトリに配置することにします。<br>
データベース名は指定しません。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql:schema.sql data-lang=sql:schema.sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>user</span> (id <span style=color:#66d9ef>int</span>, name <span style=color:#66d9ef>varchar</span>(<span style=color:#ae81ff>10</span>));
</code></pre></td></tr></table>
</div>
</div><h2 id=2-mavenプロジェクト作成>2. mavenプロジェクト作成<a hidden class=anchor aria-hidden=true href=#2-mavenプロジェクト作成>#</a></h2>
<p>先ほどのtableに適当なレコードを挿入する最小限のJavaプロジェクトを実装します。</p>
<p>JDBC、JUnit、maven-assembly-pluginを使用します。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml:pom.xml data-lang=xml:pom.xml><span style=color:#f92672>&lt;project</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
	<span style=color:#a6e22e>xmlns:xsi=</span><span style=color:#e6db74>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
	<span style=color:#a6e22e>xsi:schemaLocation=</span><span style=color:#e6db74>&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style=color:#f92672>&gt;</span>
	<span style=color:#f92672>&lt;modelVersion&gt;</span>4.0.0<span style=color:#f92672>&lt;/modelVersion&gt;</span>
	<span style=color:#f92672>&lt;groupId&gt;</span>aaaanwz<span style=color:#f92672>&lt;/groupId&gt;</span>
	<span style=color:#f92672>&lt;artifactId&gt;</span>test<span style=color:#f92672>&lt;/artifactId&gt;</span>
	<span style=color:#f92672>&lt;version&gt;</span>0.0.1<span style=color:#f92672>&lt;/version&gt;</span>
	<span style=color:#f92672>&lt;name&gt;</span>testproject<span style=color:#f92672>&lt;/name&gt;</span>
	<span style=color:#f92672>&lt;properties&gt;</span>
		<span style=color:#f92672>&lt;maven.compiler.source&gt;</span>11<span style=color:#f92672>&lt;/maven.compiler.source&gt;</span>
		<span style=color:#f92672>&lt;maven.compiler.target&gt;</span>11<span style=color:#f92672>&lt;/maven.compiler.target&gt;</span>
	<span style=color:#f92672>&lt;/properties&gt;</span>
	<span style=color:#f92672>&lt;dependencies&gt;</span>
		<span style=color:#75715e>&lt;!-- JDBC driver --&gt;</span>
		<span style=color:#f92672>&lt;dependency&gt;</span>
			<span style=color:#f92672>&lt;groupId&gt;</span>mysql<span style=color:#f92672>&lt;/groupId&gt;</span>
			<span style=color:#f92672>&lt;artifactId&gt;</span>mysql-connector-java<span style=color:#f92672>&lt;/artifactId&gt;</span>
			<span style=color:#f92672>&lt;version&gt;</span>8.0.17<span style=color:#f92672>&lt;/version&gt;</span>
		<span style=color:#f92672>&lt;/dependency&gt;</span>
		<span style=color:#75715e>&lt;!-- JUnit --&gt;</span>
		<span style=color:#f92672>&lt;dependency&gt;</span>
			<span style=color:#f92672>&lt;groupId&gt;</span>org.junit.jupiter<span style=color:#f92672>&lt;/groupId&gt;</span>
			<span style=color:#f92672>&lt;artifactId&gt;</span>junit-jupiter-engine<span style=color:#f92672>&lt;/artifactId&gt;</span>
			<span style=color:#f92672>&lt;version&gt;</span>5.3.1<span style=color:#f92672>&lt;/version&gt;</span>
			<span style=color:#f92672>&lt;scope&gt;</span>test<span style=color:#f92672>&lt;/scope&gt;</span>
		<span style=color:#f92672>&lt;/dependency&gt;</span>
	<span style=color:#f92672>&lt;/dependencies&gt;</span>
	<span style=color:#f92672>&lt;build&gt;</span>
		<span style=color:#f92672>&lt;plugins&gt;</span>
			<span style=color:#75715e>&lt;!-- JUnit test --&gt;</span>
			<span style=color:#f92672>&lt;plugin&gt;</span>
				<span style=color:#f92672>&lt;artifactId&gt;</span>maven-surefire-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
				<span style=color:#f92672>&lt;version&gt;</span>3.0.0-M3<span style=color:#f92672>&lt;/version&gt;</span>
			<span style=color:#f92672>&lt;/plugin&gt;</span>
			<span style=color:#75715e>&lt;!-- Build runnable jar --&gt;</span>
			<span style=color:#f92672>&lt;plugin&gt;</span>
				<span style=color:#f92672>&lt;artifactId&gt;</span>maven-assembly-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
				<span style=color:#f92672>&lt;executions&gt;</span>
					<span style=color:#f92672>&lt;execution&gt;</span>
						<span style=color:#f92672>&lt;phase&gt;</span>package<span style=color:#f92672>&lt;/phase&gt;</span>
						<span style=color:#f92672>&lt;goals&gt;</span>
							<span style=color:#f92672>&lt;goal&gt;</span>single<span style=color:#f92672>&lt;/goal&gt;</span>
						<span style=color:#f92672>&lt;/goals&gt;</span>
					<span style=color:#f92672>&lt;/execution&gt;</span>
				<span style=color:#f92672>&lt;/executions&gt;</span>
				<span style=color:#f92672>&lt;configuration&gt;</span>
					<span style=color:#f92672>&lt;archive&gt;</span>
						<span style=color:#f92672>&lt;manifest&gt;</span>
							<span style=color:#f92672>&lt;mainClass&gt;</span>testpackage.Main<span style=color:#f92672>&lt;/mainClass&gt;</span>
						<span style=color:#f92672>&lt;/manifest&gt;</span>
					<span style=color:#f92672>&lt;/archive&gt;</span>
					<span style=color:#f92672>&lt;descriptorRefs&gt;</span>
						<span style=color:#f92672>&lt;descriptorRef&gt;</span>jar-with-dependencies<span style=color:#f92672>&lt;/descriptorRef&gt;</span>
					<span style=color:#f92672>&lt;/descriptorRefs&gt;</span>
				<span style=color:#f92672>&lt;/configuration&gt;</span>
			<span style=color:#f92672>&lt;/plugin&gt;</span>
		<span style=color:#f92672>&lt;/plugins&gt;</span>
	<span style=color:#f92672>&lt;/build&gt;</span>
<span style=color:#f92672>&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>1レコード挿入するだけのMainクラスを実装します。<br>
データベースへの接続情報は環境変数から取得します。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java:src/main/java/testpackage/Main.java data-lang=java:src/main/java/testpackage/Main.java><span style=color:#f92672>package</span> testpackage<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> java.sql.Connection<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.sql.DriverManager<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.sql.PreparedStatement<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.sql.SQLException<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Main</span> <span style=color:#f92672>{</span>

  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ClassNotFoundException<span style=color:#f92672>,</span> SQLException <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>final</span> String host <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getenv</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DB_HOST&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>final</span> String dbname <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getenv</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DB_NAME&#34;</span><span style=color:#f92672>);</span>
    execute<span style=color:#f92672>(</span>host<span style=color:#f92672>,</span> dbname<span style=color:#f92672>);</span>
  <span style=color:#f92672>}</span>

  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>String host<span style=color:#f92672>,</span> String dbname<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ClassNotFoundException<span style=color:#f92672>,</span> SQLException <span style=color:#f92672>{</span>
    Class<span style=color:#f92672>.</span><span style=color:#a6e22e>forName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;com.mysql.cj.jdbc.Driver&#34;</span><span style=color:#f92672>);</span>
    Connection conn <span style=color:#f92672>=</span> DriverManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnection</span><span style=color:#f92672>(</span>
        <span style=color:#e6db74>&#34;jdbc:mySql://&#34;</span> <span style=color:#f92672>+</span> host <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> dbname <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?useSSL=false&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;root&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
    PreparedStatement stmt <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareStatement</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;INSERT INTO user(id,name) VALUES(?, ?)&#34;</span><span style=color:#f92672>);</span>
    stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>setInt</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> 1<span style=color:#f92672>);</span>
    stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>setString</span><span style=color:#f92672>(</span>2<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Yamada&#34;</span><span style=color:#f92672>);</span>
    stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>executeUpdate</span><span style=color:#f92672>();</span>
  <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></td></tr></table>
</div>
</div><p>レコードが挿入された事を確認するだけのテストを書きます。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java:src/test/java/testpackage/MainTest.java data-lang=java:src/test/java/testpackage/MainTest.java><span style=color:#f92672>package</span> testpackage<span style=color:#f92672>;</span>

<span style=color:#f92672>import static</span> org.junit.jupiter.api.Assertions.assertEquals<span style=color:#f92672>;</span>
<span style=color:#f92672>import static</span> org.junit.jupiter.api.Assertions.fail<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> java.sql.Connection<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.sql.DriverManager<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.sql.ResultSet<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.sql.SQLException<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.sql.Statement<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> org.junit.jupiter.api.AfterEach<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.junit.jupiter.api.BeforeEach<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.junit.jupiter.api.Test<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> testpackage.Main<span style=color:#f92672>;</span>

<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainTest</span> <span style=color:#f92672>{</span>
  Statement stmt<span style=color:#f92672>;</span>

  <span style=color:#a6e22e>@BeforeEach</span>
  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>before</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> ClassNotFoundException<span style=color:#f92672>,</span> SQLException <span style=color:#f92672>{</span>
    Class<span style=color:#f92672>.</span><span style=color:#a6e22e>forName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;com.mysql.cj.jdbc.Driver&#34;</span><span style=color:#f92672>);</span>
    Connection conn <span style=color:#f92672>=</span>
        DriverManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnection</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;jdbc:mySql://localhost/test?useSSL=false&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;root&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>);</span>
    stmt <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span><span style=color:#a6e22e>createStatement</span><span style=color:#f92672>();</span>
  <span style=color:#f92672>}</span>

  <span style=color:#a6e22e>@AfterEach</span>
  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>after</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
    stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>executeUpdate</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;TRUNCATE TABLE user&#34;</span><span style=color:#f92672>);</span>
  <span style=color:#f92672>}</span>

  <span style=color:#a6e22e>@Test</span>
  <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
    Main<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;test&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>try</span> <span style=color:#f92672>(</span>ResultSet rs <span style=color:#f92672>=</span> stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>executeQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SELECT * FROM user WHERE id = 1;&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rs<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
        assertEquals<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Yamada&#34;</span><span style=color:#f92672>,</span> rs<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>));</span>
      <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
        fail<span style=color:#f92672>();</span>
      <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id=3-dockerfile作成>3. Dockerfile作成<a hidden class=anchor aria-hidden=true href=#3-dockerfile作成>#</a></h2>
<p>Dockerfileを書きます。テストは <code>docker build</code>とは別のステップで行う予定のため、<code>-DskipTests</code>を付与してビルド時のテストをスキップします。</p>
<p>イメージサイズ削減のためmaven:3.6でビルド、openjdk11:apline-slimで実行するマルチステージビルドを行います。
maven:3.6では約800MB、openjdk11:alpine-slimでは約300MBとなります。現時点でECRの無料枠は500MBのため、個人開発では大きな差です。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>FROM maven:3.6 AS build

ADD . /var/tmp/testproject/
WORKDIR /var/tmp/testproject/
RUN mvn -DskipTests package

FROM adoptopenjdk/openjdk11:alpine-slim

COPY --from=build /var/tmp/testproject/target/test-0.0.1-jar-with-dependencies.jar /usr/local/
CMD java -jar /usr/local/test-0.0.1-jar-with-dependencies.jar.jar
</code></pre></td></tr></table>
</div>
</div><h2 id=4-k8s-yamlファイル作成>4. k8s yamlファイル作成<a hidden class=anchor aria-hidden=true href=#4-k8s-yamlファイル作成>#</a></h2>
<p>3.でビルドされたコンテナをk8sにデプロイするためのyamlを書きます。今回のプログラムは単発でSQLを実行して終了するため、<code>kind: Job</code>にしてみます。Docker registryのurlは適宜置換してください。<br>
<code>env</code>でDBへの接続情報を定義します。 <code>DB_HOST</code>の値が <code>mysql</code>となっているのは、KubernetesのService経由で接続するためです。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml:k8s-job.yaml data-lang=yaml:k8s-job.yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>batch/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Job</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test</span>
        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>your-docker-registry-url/testimage:latest</span>
        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
        <span style=color:#f92672>env</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>DB_HOST</span>
          <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;mysql&#34;</span>
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>DB_NAME</span>
          <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;ekstest&#34;</span>
      <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Never</span>
  <span style=color:#f92672>backoffLimit</span>: <span style=color:#ae81ff>0</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=5-circleci-configファイル作成>5. circleci configファイル作成<a hidden class=anchor aria-hidden=true href=#5-circleci-configファイル作成>#</a></h2>
<p>本稿のキモです。CircleCIで自動テスト/ビルドを行うための構成設定を書きます。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml:.circleci/config.yml data-lang=yml:.circleci/config.yml><span style=color:#f92672>version</span>: <span style=color:#ae81ff>2.1</span>
<span style=color:#f92672>orbs</span>:
  <span style=color:#f92672>aws-ecr</span>: <span style=color:#ae81ff>circleci/aws-ecr@6.1.0</span>
  <span style=color:#f92672>aws-eks</span>: <span style=color:#ae81ff>circleci/aws-eks@0.2.1</span>
  <span style=color:#f92672>kubernetes</span>: <span style=color:#ae81ff>circleci/kubernetes@0.3.0</span>
<span style=color:#f92672>jobs</span>:
  <span style=color:#f92672>test</span>: <span style=color:#75715e># ①JUnit テストの実行</span>
    <span style=color:#f92672>docker</span>:
      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>circleci/openjdk:11</span>
      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>circleci/mysql:5.7</span>
        <span style=color:#f92672>environment</span>:
          <span style=color:#f92672>MYSQL_ALLOW_EMPTY_PASSWORD</span>: <span style=color:#66d9ef>yes</span>
          <span style=color:#f92672>MYSQL_DATABASE</span>: <span style=color:#ae81ff>test</span>
        <span style=color:#f92672>command</span>: [--<span style=color:#ae81ff>character-set-server=utf8, --collation-server=utf8_general_ci, --default-storage-engine=innodb]</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#ae81ff>checkout</span>
      - <span style=color:#f92672>run</span>:
          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Waiting for MySQL to be ready</span>
          <span style=color:#f92672>command</span>: <span style=color:#ae81ff>dockerize -wait tcp://localhost:3306 -timeout 1m</span>
      - <span style=color:#f92672>run</span>:
          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install MySQL CLI; Create table;</span>
          <span style=color:#f92672>command</span>: <span style=color:#ae81ff>sudo apt-get install default-mysql-client &amp;&amp; mysql -h 127.0.0.1 -uroot test &lt; schema.sql</span>
      - <span style=color:#f92672>restore_cache</span>:
          <span style=color:#f92672>key</span>: <span style=color:#ae81ff>circleci-test-{{ checksum &#34;pom.xml&#34; }}</span>
      - <span style=color:#f92672>run</span>: <span style=color:#ae81ff>mvn dependency:go-offline</span>
      - <span style=color:#f92672>save_cache</span>:
          <span style=color:#f92672>paths</span>:
            - <span style=color:#ae81ff>~/.m2</span>
          <span style=color:#f92672>key</span>: <span style=color:#ae81ff>circleci-test-{{ checksum &#34;pom.xml&#34; }}</span>
      - <span style=color:#f92672>run</span>: <span style=color:#ae81ff>mvn test</span>
      - <span style=color:#f92672>store_test_results</span>:
          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>target/surefire-reports</span>
  <span style=color:#f92672>deploy</span>: <span style=color:#75715e># ③EKSへのkubectl apply</span>
    <span style=color:#f92672>executor</span>: <span style=color:#ae81ff>aws-eks/python3</span>
    <span style=color:#f92672>steps</span>:
      - <span style=color:#ae81ff>checkout</span>
      - <span style=color:#ae81ff>kubernetes/install</span>
      - <span style=color:#f92672>aws-eks/update-kubeconfig-with-authenticator</span>:
          <span style=color:#f92672>cluster-name</span>: <span style=color:#ae81ff>test-cluster</span>
          <span style=color:#f92672>aws-region</span>: <span style=color:#e6db74>&#34;${AWS_REGION}&#34;</span>
      - <span style=color:#f92672>run</span>:
          <span style=color:#f92672>command</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>            </span>            <span style=color:#ae81ff>kubectl apply -f k8s-job.yaml</span>
          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apply</span>
<span style=color:#f92672>workflows</span>:
  <span style=color:#f92672>test-and-deploy</span>:
    <span style=color:#f92672>jobs</span>: 
      - <span style=color:#f92672>test</span>: <span style=color:#75715e># ①JUnit テストの実行</span>
          <span style=color:#f92672>filters</span>:
            <span style=color:#f92672>branches</span>:
              <span style=color:#f92672>only</span>: <span style=color:#ae81ff>develop</span>
      - <span style=color:#f92672>aws-ecr/build-and-push-image</span>: <span style=color:#75715e># ②コンテナのビルドとECRへのpush</span>
          <span style=color:#f92672>filters</span>:
            <span style=color:#f92672>branches</span>:
              <span style=color:#f92672>only</span>: <span style=color:#ae81ff>master</span>
          <span style=color:#f92672>create-repo</span>: <span style=color:#66d9ef>true</span>
          <span style=color:#f92672>repo</span>: <span style=color:#e6db74>&#34;testimage&#34;</span>
          <span style=color:#f92672>tag</span>: <span style=color:#e6db74>&#34;latest&#34;</span>
      - <span style=color:#f92672>deploy</span>: <span style=color:#75715e># ③EKSへのkubectl apply</span>
          <span style=color:#f92672>requires</span>:
            - <span style=color:#ae81ff>aws-ecr/build-and-push-image</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=junitテストの実行>①JUnitテストの実行<a hidden class=anchor aria-hidden=true href=#junitテストの実行>#</a></h3>
<p>filterによって、<code>develop</code>ブランチに変更が加わった際に <code>mvn test</code>が実行されるようにしてみました。この際テスト用MySQLインスタンスが立ち上がり、 <code>test</code>データベースが準備されます。</p>
<p>公式ドキュメントで詳しく解説されています。　　</p>
<ul>
<li><a href=https://circleci.com/docs/2.0/language-java/>Language Guide: Java</a></li>
<li><a href=https://circleci.com/docs/2.0/postgres-config/>Database Configuration Examples</a></li>
</ul>
<h3 id=コンテナのビルドとecrへのpush>②コンテナのビルドとECRへのpush<a hidden class=anchor aria-hidden=true href=#コンテナのビルドとecrへのpush>#</a></h3>
<p><code>master</code>ブランチに変更が加わった際に、Dockerfileに従ってbuildし、ECRにpushします。<br>
<a href=https://circleci.com/orbs/registry/orb/circleci/aws-ecr>Orbクイックスタートガイド</a>で詳しく解説されています。</p>
<h3 id=eksへのkubectl-apply>③EKSへのkubectl apply<a hidden class=anchor aria-hidden=true href=#eksへのkubectl-apply>#</a></h3>
<p>②が実施された後、4.で定義したJobを実行します。<br>
<a href=https://circleci.com/orbs/registry/orb/circleci/aws-eks>circleci/aws-eks</a>に解説がありますが、サンプルコードをよりシンプルに変更しました。<br>
@0.2.1のドキュメントによるとパラメータ<code>aws-region</code>はRequiredとなっていませんが、実際は必須のようです。ECRのpushで環境変数<code>AWS_REGION</code>を要求されているので、これをそのまま使いました。</p>
<h1 id=インフラ設定>インフラ設定<a hidden class=anchor aria-hidden=true href=#インフラ設定>#</a></h1>
<p>ほとんど公式ドキュメントへのリンク集です。</p>
<h2 id=1-ecr-eks環境準備>1. ECR, EKS環境準備<a hidden class=anchor aria-hidden=true href=#1-ecr-eks環境準備>#</a></h2>
<h3 id=1-1-基本設定>1-1. 基本設定<a hidden class=anchor aria-hidden=true href=#1-1-基本設定>#</a></h3>
<p><code>test-cluster</code>を立ち上げます。</p>
<ul>
<li><a href=https://docs.aws.amazon.com/eks/latest/userguide/getting-started.html>Getting Started with Amazon EKS</a></li>
<li><a href=https://docs.aws.amazon.com/AmazonECR/latest/userguide/get-set-up-for-amazon-ecr.html>Setting Up with Amazon ECR</a></li>
</ul>
<h3 id=1-2-eks上にmysqlをデプロイ>1-2. EKS上にMySQLをデプロイ<a hidden class=anchor aria-hidden=true href=#1-2-eks上にmysqlをデプロイ>#</a></h3>
<p>Kubernetes公式に<a href=https://kubernetes.io/docs/tasks/run-application/run-single-instance-stateful-application/#deploy-mysql>Deploy MySQL</a>というドキュメントが用意されています。<br>
<code>kubectl exec -it mysql-0 mysql</code>コマンドから<code>ekstest</code>データベースと<code>user</code>テーブルを用意します。</p>
<h2 id=2-circleci-projectの設定>2. CircleCI projectの設定<a hidden class=anchor aria-hidden=true href=#2-circleci-projectの設定>#</a></h2>
<h3 id=2-1-プロジェクトのセットアップ>2-1. プロジェクトのセットアップ<a hidden class=anchor aria-hidden=true href=#2-1-プロジェクトのセットアップ>#</a></h3>
<ul>
<li><a href=https://circleci.com/docs/enterprise/quick-start/>quick-start</a></li>
</ul>
<h3 id=2-2-環境変数の設定>2-2. 環境変数の設定<a hidden class=anchor aria-hidden=true href=#2-2-環境変数の設定>#</a></h3>
<ul>
<li><a href=https://circleci.com/orbs/registry/orb/circleci/aws-ecr>circleci/aws-ecr</a>でRequiredとなっている環境変数をCircleCI Projectに<a href=https://circleci.com/docs/2.0/env-vars/#setting-an-environment-variable-in-a-project>設定</a>します。<br>
Roleに要求される権限の詳細は割愛します。</li>
</ul>
<h1 id=まとめ>まとめ<a hidden class=anchor aria-hidden=true href=#まとめ>#</a></h1>
<ul>
<li>develop branchにpush<br>
　mvn testが実行され、テストレポートがCircleCIのTest summaryに表示されます。</li>
<li>master branchにpush<br>
ECRにdocker imageがpushされ、EKSでJobが開始します。EKS上のMySQLに <code>id:1 name:Yamada</code>レコードが挿入されます。</li>
</ul>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://aaaanwz.github.io/post/2019/github-actions-lambda-deploy/>
<span class=title>« Prev Page</span>
<br>
<span>Github ActionsでAWS Lambdaにデプロイする</span>
</a>
<a class=next href=https://aaaanwz.github.io/post/2019/java-k8s-liveness-probe/>
<span class=title>Next Page »</span>
<br>
<span>Kubernetes Liveness ProbeでJavaプロセスを監視する</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://aaaanwz.github.io/>A4 tech note</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>