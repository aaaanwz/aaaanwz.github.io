---
title: "因果推論を用いたA/Bテスト設計"
date: 2024-02-04
draft: false
categories:
- データサイエンス
- グロースハック
---

## 0. 前提条件

### Must
- プロダクトのKPIがユーザー行動ログから算出可能な形で定義されている
- ユーザー行動ログがDWHに格納されている
- ユーザー単位でA/Bテストを実施できる

### Nice to have
- KPIと売上(利益)の相関が計算できる
  - 施策のROIが計算できるようになります

## 1. その施策で改善したいKPIを決める (PdM)
KPIは複数で構いません。  
ex. 月間平均訪問回数, 1セッションあたりの平均滞在時間

## 2. テスト期間とコントロール/テスト比率を決める（PdM・DS）
全ユーザーの何%に対してどれだけの期間施策を配信するかについて、以下の考え方をベースに決定します。

### 比率を大きくした場合 (ex. 50:50)
- テスト期間が短くても統計的有意差が出やすい
- 施策の効果がネガティブだった場合の損失が大きい

> ちょっとしたデザイン変更など、ローリスクな施策の場合は比率を大きくする

### 比率を小さくした場合 (ex. 90:10)
- テスト期間を長くとらないと統計的有意差が出ない

> ユーザー体験に劇的な変化をもたらす施策の場合はテスト群の比率を小さく、テスト期間を長くする。

ある程度の規模のサービスにおける大雑把な目安として、テスト群にアクティブユーザーが1000人以上含まれればOKです。

## 3. そのKPIの分布が等しくなるようにユーザーをコントロール/テスト群に分ける（DS)

### 方法A. 層別サンプリング

KPIを2~4層に分け、それぞれのセグメントの人数バランスが等しくなるようにコントロール/テスト群対象者をサンプリングする方法。

|算出期間:過去1年間|訪問頻度 0~33%ile|訪問頻度 34~66%ile|訪問頻度 67~100%ile|
|-|-|-|-|
|平均滞在時間 0~33%ile|ctrl 70人:test 30人|ctrl 140人:test:60人|ctrl 105人:test 45人|
|平均滞在時間 34~66%ile|...|...|...|
|平均滞在時間 66~100%ile|...|...|...|

この方法は簡単で分かりやすい反面、層数やKPI数が多いとセグメントに含まれるユーザー数が少なくなり検定が行えないケースがある。

### 方法B. 傾向スコアマッチング

施策が適用される確率(=傾向スコア)を予測する機械学習モデルを作成し、傾向スコアが等しくなるようにコントロール/テスト群を振り分ける方法。

例えばボタンのデザイン変更施策であればそのボタンの予測クリック率が傾向スコアとなる。

